//
//====== MAP DATA ======
//

// Note(ian): The map data is included raw because javascript is shit at loading files in a way that will work locally and when running online and also doesn't have includes.
var map1 = 
{
// PASTE MAP DATA BELOW HERE
 "height":30,
 "layers":[
        {
         "data":[114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 26, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 130, 130, 114, 114, 114, 114, 114, 114, 130, 130, 130, 130, 130, 130, 130, 114, 114, 114, 114, 114, 114, 114, 114, 114, 114, 130, 114, 114, 114, 116, 146, 146, 117, 130, 130, 130, 130, 116, 146, 146, 146, 146, 146, 146, 146, 117, 130, 130, 114, 114, 114, 114, 114, 114, 116, 146, 117, 130, 116, 132, 146, 146, 133, 146, 146, 146, 146, 132, 146, 146, 146, 146, 146, 146, 146, 133, 146, 146, 117, 130, 130, 114, 114, 116, 132, 146, 133, 146, 132, 132, 146, 146, 133, 146, 146, 146, 146, 132, 146, 146, 146, 146, 146, 146, 146, 133, 146, 146, 133, 146, 146, 117, 114, 132, 132, 146, 133, 146, 132, 29, 29, 29, 29, 146, 146, 146, 146, 29, 29, 29, 29, 29, 29, 29, 29, 29, 146, 146, 133, 146, 146, 133, 117, 132, 29, 29, 133, 146, 132, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 146, 146, 133, 133, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 133, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29],
         "height":30,
         "name":"Grass",
         "opacity":1,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }, 
        {
         "data":[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 107, 0, 0, 0, 0, 0, 148, 0, 0, 149, 0, 101, 101, 101, 148, 0, 0, 0, 0, 0, 0, 0, 149, 0, 0, 0, 0, 0, 0, 0, 107, 148, 149, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 149, 239, 0, 0, 0, 148, 0, 0, 149, 146, 148, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 238, 239, 0, 149, 0, 0, 0, 0, 0, 70, 71, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 70, 71, 0, 0, 0, 0, 253, 169, 255, 0, 0, 149, 0, 0, 0, 0, 86, 87, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 86, 87, 0, 0, 0, 253, 169, 169, 169, 255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 56, 57, 58, 0, 91, 0, 0, 0, 214, 215, 216, 0, 0, 0, 91, 0, 169, 169, 169, 169, 169, 0, 0, 0, 0, 0, 0, 0, 91, 0, 72, 73, 74, 0, 0, 0, 0, 0, 230, 231, 232, 0, 0, 0, 234, 0, 185, 185, 185, 185, 185, 0, 0, 0, 0, 0, 91, 85, 0, 0, 88, 89, 90, 0, 85, 0, 0, 0, 246, 247, 248, 0, 234, 0, 0, 91, 249, 249, 249, 249, 249, 85, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 234, 0, 0, 186, 186, 186, 186, 186, 0, 0, 165, 165, 165, 165, 200, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 166, 0, 0, 0, 0, 234, 0, 186, 186, 154, 186, 186, 0, 0, 0, 0, 0, 0, 180, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 182, 0, 0, 102, 103, 0, 0, 186, 186, 186, 186, 186, 0, 0, 0, 161, 162, 162, 178, 162, 163, 0, 0, 0, 0, 0, 0, 0, 0, 0, 184, 0, 0, 0, 0, 0, 0, 186, 186, 186, 186, 186, 0, 0, 0, 177, 178, 178, 178, 178, 179, 0, 0, 0, 0, 0, 0, 0, 0, 0, 196, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 0, 177, 178, 178, 178, 178, 179, 0, 0, 0, 171, 172, 172, 172, 172, 172, 172, 172, 172, 172, 173, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 177, 178, 178, 178, 178, 179, 0, 0, 0, 187, 6, 7, 7, 7, 7, 7, 7, 7, 8, 189, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 177, 178, 178, 178, 178, 179, 0, 0, 0, 187, 22, 23, 23, 23, 23, 23, 23, 23, 24, 189, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 193, 194, 194, 194, 194, 195, 0, 0, 0, 187, 22, 23, 23, 23, 23, 23, 23, 23, 24, 189, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 187, 22, 23, 23, 23, 23, 23, 23, 23, 24, 189, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 187, 38, 39, 39, 39, 39, 39, 39, 39, 40, 189, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 203, 204, 204, 204, 204, 221, 174, 204, 204, 204, 205, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
         "height":30,
         "name":"BaseDecor",
         "opacity":1,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }, 
        {
         "data":[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 124, 0, 236, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
         "height":30,
         "name":"Interior",
         "opacity":1,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }, 
        {
         "data":[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 136, 134, 78, 78, 79, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 213, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 93, 0, 95, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 229, 0, 0, 0, 0, 94, 0, 0, 0, 0, 0, 0, 80, 80, 78, 80, 80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 245, 246, 0, 248, 109, 110, 111, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 109, 128, 110, 128, 111, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 125, 128, 110, 128, 127, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128, 128, 126, 128, 128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 250, 128, 108, 141, 112, 128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 250, 0, 0, 108, 141, 141, 141, 112, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 250, 0, 250, 0, 140, 144, 142, 142, 143, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 140, 142, 142, 142, 143, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 156, 158, 157, 158, 159, 0, 0, 0, 0, 118, 0, 227, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 118, 227, 0, 118, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 118, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 0, 66, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 227, 0, 227, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 49, 0, 82, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 51, 0, 81, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 227, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 213, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 229, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 245, 246, 0, 248, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
         "height":30,
         "name":"House",
         "opacity":1,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }, 
        {
         "draworder":"topdown",
         "height":0,
         "name":"Data",
         "objects":[
                {
                 "ellipse":true,
                 "height":1.5,
                 "id":2,
                 "name":"playerSpawn",
                 "rotation":0,
                 "type":"",
                 "visible":true,
                 "width":1.5,
                 "x":101.134027777778,
                 "y":73.292297979798
                }],
         "opacity":1,
         "type":"objectgroup",
         "visible":true,
         "width":0,
         "x":0,
         "y":0
        }, 
        {
         "data":[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 21, 0, 0, 0, 0, 21, 21, 21, 21, 21, 21, 21, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 21, 21, 21, 21, 21, 21, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 21, 0, 0, 0, 0, 21, 21, 21, 21, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 21, 0, 21, 0, 0, 21, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 21, 0, 0, 0, 21, 21, 21, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 21, 21, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 21, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 21, 0, 0, 0, 21, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 21, 21, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 21, 21, 0, 21, 21, 21, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21],
         "height":30,
         "name":"collision",
         "opacity":0.200000002980232,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }],
 "nextobjectid":3,
 "orientation":"orthogonal",
 "renderorder":"right-down",
 "tileheight":4,
 "tilesets":[
        {
         "columns":16,
         "firstgid":1,
         "image":"FarmerSceneryTileset.png",
         "imageheight":64,
         "imagewidth":64,
         "margin":0,
         "name":"FarmerSceneryTileset",
         "spacing":0,
         "terrains":[
                {
                 "name":"Path",
                 "tile":177
                }, 
                {
                 "name":"Soil",
                 "tile":22
                }],
         "tilecount":256,
         "tileheight":4,
         "tiles":
            {
             "160":
                {
                 "terrain":[-1, -1, -1, 0]
                },
             "161":
                {
                 "terrain":[-1, -1, 0, 0]
                },
             "162":
                {
                 "terrain":[-1, -1, 0, -1]
                },
             "163":
                {
                 "terrain":[-1, -1, -1, 0]
                },
             "164":
                {
                 "terrain":[-1, -1, 0, 0]
                },
             "165":
                {
                 "terrain":[-1, -1, 0, -1]
                },
             "176":
                {
                 "terrain":[-1, 0, -1, 0]
                },
             "177":
                {
                 "terrain":[0, 0, 0, 0]
                },
             "178":
                {
                 "terrain":[0, -1, 0, -1]
                },
             "179":
                {
                 "terrain":[-1, 0, -1, 0]
                },
             "181":
                {
                 "terrain":[0, -1, 0, -1]
                },
             "192":
                {
                 "terrain":[-1, 0, -1, -1]
                },
             "193":
                {
                 "terrain":[0, 0, -1, -1]
                },
             "194":
                {
                 "terrain":[0, -1, -1, -1]
                },
             "195":
                {
                 "terrain":[-1, 0, -1, -1]
                },
             "196":
                {
                 "terrain":[0, 0, -1, -1]
                },
             "197":
                {
                 "terrain":[0, -1, -1, -1]
                },
             "21":
                {
                 "terrain":[-1, 1, -1, 1]
                },
             "22":
                {
                 "terrain":[1, 1, 1, 1]
                },
             "23":
                {
                 "terrain":[1, -1, 1, -1]
                },
             "37":
                {
                 "terrain":[-1, 1, -1, -1]
                },
             "38":
                {
                 "terrain":[1, 1, -1, -1]
                },
             "39":
                {
                 "terrain":[1, -1, -1, -1]
                },
             "5":
                {
                 "terrain":[-1, -1, -1, 1]
                },
             "6":
                {
                 "terrain":[-1, -1, 1, 1]
                },
             "7":
                {
                 "terrain":[-1, -1, 1, -1]
                }
            },
         "tilewidth":4,
         "transparentcolor":"#323f32"
        }],
 "tilewidth":4,
 "version":1,
 "width":30
// PASTE MAP DATA ABOVE HERE
};

// BLITTING A SINGLE PIXEL
// var id = myContext.createImageData(1, 1);
// var d = id.data;
// d[0] = r;
// d[1] = g;
// d[2] = b;
// d[3] = a;
// myContext.putImageData(id, x, y);

// EDITING IMAGE DATA
// var imageData = ctx.getImageData(x, y, width, height);
// var pixels = imageData.data;
// imageData is an array stored rgbargba...


//
//====== SETUP ======
//

//http://www.dbp-consulting.com/tutorials/canvas/CanvasKeyEvents.html
//https://developer.mozilla.org/en-US/docs/Web/Events
/*click
contextmenu // right button before context menu is shown
dblclick?
fullscreenchange
fullscreenerror
gamepadconnected
gamepaddisconnected
keydown, keypress, keyup
mousedown, mousemove, mouseleave, mouseenter, mouseup, mouseout, mouseover*/

/* http://phoboslab.org/log/2012/09/drawing-pixels-is-hard
Safari 
  Check the backingStorePixelRatio. If it's not 1, divide your canvas size and the destination 
  size of all image draw calls by it, then scale the canvas element up using CSS and the 
  image-rendering property. (Safari)
Chrome & Firefox
  Check if the imageSmoothingEnabled property is available and if so, set it to false. Create
  your Canvas in the final, scaled size and draw all images with your scaling factor. Don't 
  use CSS to scale the Canvas.
  The above is actually wrong becuase the windows surface pro can have window.devicePixelRatio
  of 2. So:
  In order to draw at the native hardware resolution, you'd have to do your image scaling in JavaScript as usual but with twice the scaling factor, create the canvas with twice the internal size and then scale it down again using CSS.
Internet Explorer
  Use JavaScript to scale up all images at load time.
*/

var desiredPixelSize = 4;
var devicePixelRatio = window.devicePixelRatio || 1; // Todo(ian): Verify this works.
var canvasScale = desiredPixelSize * devicePixelRatio;

var canvas = document.createElement("canvas");
var canvasContext = canvas.getContext("2d");
var baseCanvasWidth = 64;
var baseCanvasHeight = 64;
canvas.width = baseCanvasWidth * canvasScale;
canvas.height = baseCanvasHeight * canvasScale;
canvas.style.width = (canvas.width/devicePixelRatio).toString() + "px";
canvas.style.height = (canvas.height/devicePixelRatio).toString() + "px";
//canvas.style.display = "block";
canvas.style.margin = "0px auto";
canvas.setAttribute("tabindex", 0);
document.body.appendChild(canvas);
// Blog talking about how to scale the canvas on the various browsers.
// http://phoboslab.org/log/2012/09/drawing-pixels-is-hard
canvasContext.webkitImageSmoothingEnabled = false;
canvasContext.mozImageSmoothingEnabled = false;
canvasContext.imageSmoothingEnabled = false;

//====== INPUT ======
canvas.addEventListener("mousedown", doMouseDown, true);
function doMouseDown(event)
{
    //canvas_x = event.pageX;
}

var nextKeysPressed = {};
var keysPressed;
canvas.addEventListener("keypress", doKeyPress, true);
function doKeyPress(e)
{
	nextKeysPressed[e.keyCode] = true;
}

var keysDown = {};
canvas.addEventListener("keydown", doKeyDown, true);
function doKeyDown(e)
{
	keysDown[e.keyCode] = true;
}
canvas.addEventListener("keyup", doKeyUp, true);
function doKeyUp(e)
{
	keysDown[e.keyCode] = false;
}

function ascii(character)
{
    var result = character.charCodeAt(0);
    return result;
}

function particle(position, velocity, drag, life)
{
    this.position = position;
    this.velocity = velocity;
    this.drag = drag;
    this.life = 0;
    this.lifeMax = life;
}

var particles = [];
function addParticle(particle)
{
    particles[particles.length] = particle;
}

//
//====== UPDATE ======
//

function update(secondsElapsed) 
{
	var darkestRate = 0.5;
	hourOfDay += (secondsElapsed/3600) * 1500;
	if (hourOfDay > 24)
	{
		hourOfDay = 0;
		// Todo(ian): If you missed bed time, faint?
	}
	if (hourOfDay < 5)
	{
		daylightRate = darkestRate;
	}
	else if (hourOfDay < 8)
	{
		var totalHours = 8-5;
		var timeInMode = hourOfDay - 5;
		var rateInMode = timeInMode / totalHours;
		daylightRate = lerp(darkestRate, 0, rateInMode);
	}
	else if (hourOfDay < 17)
	{
		daylightRate = 0;
	}
	else if (hourOfDay < 20)
	{
		var totalHours = 20 - 17;
		var timeInMode = hourOfDay - 17;
		var rateInMode = timeInMode / totalHours;
		daylightRate = lerp(0, darkestRate, rateInMode);
	}
	else
	{
		daylightRate = darkestRate;
	}
	
    keysPressed = nextKeysPressed;
    nextKeysPressed = {};
    
    if(keysPressed[ascii("q")])
    {
        debug = !debug;
    }
	
	if (playerAction != null)
	{
		// Start Actions
		var isActionKeyStillDown = false;
		for(var keyIndex = 0;
			keyIndex < playerAction.keys.length && !isActionKeyStillDown;
			keyIndex++)
		{
			isActionKeyStillDown = keysDown[playerAction.keys[keyIndex]];
		}
		if(!isActionKeyStillDown)
		{
			// End Action
			if(playerAction.name == "move")
			{
				player.sprite = player.sprite.animatedFrameSprite.frames[0];
			}
			playerAction = null;
		}
	}
	else if(playerAction == null)
	{
		// End Actions
		// Todo(ian): Arrow keys and gamepad?
		var upKeys = [ascii("W"), ascii("w")];
		playerAction = testAndCreateMoveAction(upKeys, 0, -1, playerSpriteUp);
		if (playerAction == null)
		{
			var downKeys = [ascii("S"), ascii("s")];
			playerAction = testAndCreateMoveAction(downKeys, 0, 1, playerSpriteDown);
		}
		if (playerAction == null)
		{
			var leftKeys = [ascii("A"), ascii("a")];
			playerAction = testAndCreateMoveAction(leftKeys, -1, 0, playerSpriteLeft);
		}
		if (playerAction == null)
		{
			var rightKeys = [ascii("D"), ascii("d")];
			playerAction = testAndCreateMoveAction(rightKeys, 1, 0, playerSpriteRight);
		}
	}
	
	// Handle Active Player Actions
	if(playerAction != null)
	{
		if(playerAction.name == "move")
		{
			playerAction.currentSeconds += secondsElapsed;
			if(playerAction.currentSeconds >= playerAction.totalSeconds)
			{
				TryMoveEntity(player, playerAction.dx, playerAction.dy);
				playerAction.currentSeconds = 0;
			}
			
			// Tile movement.
			// var preUpdateSeconds = playerAction.currentSeconds;
			// playerAction.currentSeconds += secondsElapsed;
			// // Note(ian): We can seperate x and y if tiles stop being square.
			// var moveTime = playerAction.totalSeconds / mapData.tileWidth;
			// for(var timePointIndex = 0;
				// timePointIndex < mapData.tileWidth;
				// timePointIndex++)
			// {
				// var timePoint = moveTime * timePointIndex;
				// if(preUpdateSeconds <= timePoint && timePoint < playerAction.currentSeconds)
				// {
					// player.position.x += playerAction.dx;
					// player.position.y += playerAction.dy;
				// }
			// }
			// if(playerAction.currentSeconds >= playerAction.totalSeconds)
			// {
				// playerAction = null;
			// }
		}
	}
	cameraOffset.x = -(player.position.x + (mapData.tileWidth / 2) - (baseCanvasWidth / 2));
	cameraOffset.y = -(player.position.y + (mapData.tileWidth / 2) - (baseCanvasHeight / 2));
    
    // Entity Updates
    for(i = 0;
        i < entities.length;
        i++)
    {
        var entity = entities[i];
        // Coins
        if(entity.type == "coin")
        {
            var distanceToPickupCoin = 25;
            if(v2Length(v2Subtract(player.position, entity.position)) < distanceToPickupCoin)
            {
                var index = entities.indexOf(entity);
                entities.splice(index, 1);
            }
        }
    
        // Animation
        var sprite = entity.sprite;
        if(sprite != null)
		{
			if(sprite.type == "animated")
			{
				sprite.animationSeconds += secondsElapsed;
				var numFrames = sprite.image.width / sprite.frameWidth;
				var totalAnimationSeconds = numFrames * (1/sprite.framesPerSecond);
				if(sprite.animationSeconds > totalAnimationSeconds)
				{
					sprite.animationSeconds -= totalAnimationSeconds;
				}
			}
			else if(sprite.type == "animatedFrames")
			{
				sprite.animationSeconds += secondsElapsed;
				var totalAnimationSeconds = sprite.animatedFrameSprite.frames.length * (1 / sprite.animatedFrameSprite.framesPerSecond);
				if(sprite.animationSeconds > totalAnimationSeconds)
				{
					sprite.animationSeconds -= totalAnimationSeconds;
				}
			}
        }
    }
    
    for(i = particles.length -1;
        i >= 0;
        i--)
    {
        var particle = particles[i];
        
        var acceleration = new v2Copy(particle.velocity);
        acceleration.x *= -particle.drag;
        acceleration.y *= -particle.drag;
        
        var positionDelta = v2Add(
            v2Multiply(acceleration, 0.5 * Math.pow(secondsElapsed, 2)), 
            v2Multiply(particle.velocity, secondsElapsed)); 
    
        particle.velocity = v2Add(
            particle.velocity, 
            v2Multiply(acceleration, secondsElapsed));
      
        particle.position = v2Add(particle.position, positionDelta);  
        
        particle.life += secondsElapsed;
        if(particle.life < particle.lifeMax)
        {
            particles.splice(i, 1);
        }
    }
}

function TryMoveEntity(entity, dx, dy)
{
	var x = entity.position.x + dx;
	var y = entity.position.y + dy;
	var postMoveRectangle = new rectangle(x, y, 4, 4);
	
	var collision = false;
	for(var mapX = 0;
		mapX < mapData.width && !collision;
		mapX++)
	{
		for(var mapY = 0;
			mapY < mapData.height && !collision;
			mapY++)
		{
			var mapIndex = mapX + (mapY * mapData.width);
			if(mapData.collisionTiles[mapIndex] != 0)
			{
				var tileRectangle = new rectangle(mapX * 4, mapY * 4, 4, 4);
				if(rectanglesAllignedOverlap(postMoveRectangle, tileRectangle))
				{
					collision = true;
				}
			}
		}
	}
	
	if(!collision)
	{
		entity.position.x += dx;
		entity.position.y += dy;
	}
}

function testAndCreateMoveAction(keys, dx, dy, sprite)
{
	var result = null;
	var keyIsDown = false;
	for(var keyIndex = 0;
		keyIndex < keys.length && !keyIsDown;
		keyIndex++)
	{
		keyIsDown = keysDown[keys[keyIndex]];
	}
	if(keyIsDown)
	{
		result = {};
		result.name = "move"
		result.keys = keys;
		result.currentSeconds = 0;
		result.totalSeconds = 0.05;
		result.dx = dx;
		result.dy = dy;
		player.sprite = new animatedFrameSpriteInstance(sprite);
	}
	return result;
}

function setVolumeFadeIn(sound, fadeLength)
{        
    var volume = 1;
    if(sound.currentTime < fadeLength)
    {
        volume = sound.currentTime * (1 / fadeLength);
    }
    var timeToEnd = sound.duration - sound.currentTime;
    if(timeToEnd < fadeLength)
    {
        volume = timeToEnd * (1 / fadeLength);
    }
    sound.volume = volume;
}

function approach(start, destination, rate)
{
    if(start < destination)
    {
        return Math.min(start + rate, destination);
    }
    else
    {
        return Math.max(start - rate, destination);
    }
}

//
//====== DRAW ======
//

function draw()
{
    canvasContext.fillStyle = '#000000';
	canvasContext.fillRect(0,0,canvas.width,canvas.height);
	
	for(i = 0;
        i < mapData.layers.length;
        i++)
    {
        var layer = mapData.layers[i];
        for(var tileX = 0;
            tileX < mapData.width;
            tileX++)
        {
            for(var tileY = 0;
                tileY < mapData.height;
                tileY++)
            {
                var spriteId = layer.data[tileX + (tileY * mapData.width)];
                if(spriteId != 0)
                {
                    var x = tileX * mapData.tileWidth;
                    var y = tileY * mapData.tileHeight;
					
					var spritesTileSet = null;
					for(var tileSetIndex = 0;
						tileSetIndex < mapData.tileSets.length && spritesTileSet == null;
						tileSetIndex++)
					{
						var tileSet = mapData.tileSets[tileSetIndex];
						if(spriteId < tileSet.firstId + tileSet.tileCount)
						{
							spritesTileSet = tileSet;
						}
					}
					
					var tileSetId = spriteId - spritesTileSet.firstId;
					var tileSetTileX = tileSetId % spritesTileSet.widthInTiles;
					var tileSetTileY = Math.floor(tileSetId / spritesTileSet.widthInTiles);
					
					var tileSetX = tileSetTileX * mapData.tileWidth;
					var tileSetY = tileSetTileY * mapData.tileHeight;
					
					canvasContext.drawImage(spritesTileSet.image, 
						tileSetX, tileSetY, mapData.tileWidth, mapData.tileHeight,
						(x + cameraOffset.x) * canvasScale, 
						(y + cameraOffset.y) * canvasScale, 
						mapData.tileWidth * canvasScale, 
						mapData.tileHeight * canvasScale);
                }
            }
        }
    }
    
    // todo(ian): Order by Y value before drawing.
    entities.sort(
        function (a, b)
        {
            return a.position.y - b.position.y;
        });
    
    for(i = 0;
        i < entities.length;
        i++)
    {
        drawEntity(entities[i]);
    }
    
    // backing for coins and text
    // var backingHeight = 20;
    // drawRectangle2(new v2(0, baseHeight - backingHeight), new v2(baseWidth, backingHeight), "#404040", false);
        
    // var fontHeight = 16;
    // drawText(new v2(10, baseHeight - fontHeight - 4), coinsText, fontHeight, "#ffffff");
        
	// var fontHeight = 10;
	// canvasContext.font = fontHeight + "px " + font; // note(ian): Must set this for measureText to work.
	// var x = (baseWidth - canvasContext.measureText(activePhrase).width) / 2;
	// var y = baseHeight - 6 - fontHeight;
	// drawText(new v2(x, y), activePhrase, fontHeight, "#FFFFFF");
	    
    for(i = particles.length -1;
        i >= 0;
        i--)
    {
        var particle = particles[i];
        var lifePercent = particle.live / particle.lifeMax;
        var sprite = smokeSprite;
        if(lifePercent > 0.25)
        {
            sprite = smokeSprite2;
        }
        if(lifePercent > 0.50)
        {
            sprite = smokeSprite3;
        }
        if(lifePercent > 0.75)
        {
            sprite = smokeSprite4;
        }
        drawSprite(sprite, particle.position, false);
    }
	
	canvasContext.save();
	canvasContext.globalAlpha = daylightRate;
	drawRectangle(new v2(0, 0), new v2(64, 64), '#111111', false);
	canvasContext.restore();
}

// function drawRectangleCentered(center, size, color)
// {
    // color = color || 'magenta';
    // var halfSize = v2Divide(size, 2);
    // var topLeft = v2Subtract(center, halfSize);
    // topLeft = v2Multiply(topLeft, camera.scale);
    // topLeft = v2Subtract(topLeft, camera.offset);
    // canvasContext.fillStyle = color;
    // canvasContext.fillRect(topLeft.x, topLeft.y, size.x * camera.scale, size.y * camera.scale);
// }

function drawRectangle(topLeft, size, color, offset)
{
    //color = color || 'magenta';
    var start = v2Copy(topLeft);
    if(offset)
    {
        start = v2Subtract(start, cameraOffset);
    }
    canvasContext.fillStyle = color;
    canvasContext.fillRect(
		start.x * canvasScale, 
		start.y * canvasScale, 
		size.x * canvasScale, 
		size.y * canvasScale);
}

// function drawCircle(x, y)
// {
    // var radius = 2 * camera.scale;
    // canvasContext.beginPath();
    // x = (x * camera.scale) - camera.offset.x;
    // y = (y * camera.scale) - camera.offset.y;
    // //canvasContext.arc(x, canvasContext.canvas.height - y, radius, 0, 2 * Math.PI, false);
    // canvasContext.arc(x, y, radius, 0, 2 * Math.PI, false);
    // canvasContext.fillStyle = 'green';
    // canvasContext.fill();
// }

function drawEntity(entity)
{
    if(entity.sprite != null)
    {
        drawSprite(entity.sprite, entity.position, false);
    }
    
    // if(debug)
    // {
        // if(entity.physics != null)
        // {
            // drawRectangle(entity.position, entity.physics.size);
        // }
        // drawCircle(entity.position.x, entity.position.y);
    // }
}

function drawSprite(
    sprite, 
    position,
    ignoreCameraOffset // True when drawing UI elements.
    )
{   
	if(sprite.type == "animatedFrames")
	{
		var frame = Math.floor(sprite.animationSeconds * sprite.animatedFrameSprite.framesPerSecond);
		frame = frame % sprite.animatedFrameSprite.frames.length;
		sprite = sprite.animatedFrameSprite.frames[frame];
	}

    var sourceX = 0;
    var sourceY = 0;
    var width = sprite.image.width;
    var height = sprite.image.height;
        
    if(sprite.type == "animated")
    {
        var frame = Math.floor(sprite.animationSeconds * sprite.framesPerSecond);
        sourceX = sprite.frameWidth * frame;
        width = sprite.frameWidth;
        height = sprite.frameHeight;
    }
	
	var y = position.y;
    var x = position.x;
    
    if(!ignoreCameraOffset)
    {
        x += cameraOffset.x;
        y += cameraOffset.y;
    }
	
    y *= canvasScale;
    x *= canvasScale;
    
    //canvasContext.save();
    //canvasContext.translate(x + (width * canvasScale / 2), y + (height * canvasScale / 2));
    
    // Note(ian): Art is drawn  facing up instead of right so adjust here.
    //canvasContext.rotate(rotation - sprite.artRotation);
    
    // if(sprite.flipH)
    // {
        // canvasContext.save();
        // canvasContext.translate(canvas.width, 0);
        // canvasContext.scale(-1, 1);
        // x = canvas.width - x - (sprite.frameWidth * camera.scale);
    // }
    
    // canvasContext.drawImage(sprite.image, sourceX, sourceY, width, height,
        // -width * canvasScale / 2, 
        // -height * canvasScale / 2, 
        // width * canvasScale, 
        // height * canvasScale); 
		
	canvasContext.drawImage(sprite.image,
		sourceX, sourceY, width, height,
        x, y, width * canvasScale, height * canvasScale);
    
    //canvasContext.restore();
    
    // if(sprite.flipH)
    // {
        // canvasContext.restore();
    // }
}

var font = "Arial";
function drawText(start, text, fontHeight, color)
{
    color = color || colorText;
    canvasContext.font = fontHeight + "px " + font;
    canvasContext.fillStyle = color;
    
    var position = new v2(start.x, start.y);
    position.y += fontHeight;
    
    canvasContext.save();
    canvasContext.scale(camera.scale, camera.scale);
    canvasContext.fillText(text, position.x, position.y);
    canvasContext.restore();
}

//
//====== INITIALIZE ======
//

function staticSprite(name, artRotation)
{
    this.type = "static";
    this.image = new Image();
    this.image.src = name;
    this.artRotation = artRotation; // some art (like rockets) is drawn facing up when it should be drawn facing right
}

function animatedSprite(name, frameWidth, frameHeight, framesPerSecond)
{
    this.type = "animated";
    this.image = new Image();
    this.image.src = name;
    this.frameWidth = frameWidth;
    this.frameHeight = frameHeight;
    this.animationSeconds = 0;
    this.framesPerSecond = framesPerSecond;
    this.flipH = false;
}

function animatedFrameSprite(root, number, framesPerSecond)
{
    this.frames = loadSpriteSet(root, number);
    this.framesPerSecond = framesPerSecond;
}

function loadSpriteSet(root, number)
{
	var result = [];
	for (var i = 0; i < number; i++)
	{
		var unpaddedString = "" + i;
		var numberAsString = "0000".substring(0, 4 - (unpaddedString.length)) + unpaddedString; 
		var path = root + numberAsString + ".png";
		result[result.length] = new staticSprite(path, 0);
	}
	return result;
}

function animatedFrameSpriteInstance(animatedFrameSprite)
{
    this.type = "animatedFrames";
	this.animatedFrameSprite = animatedFrameSprite
    this.flipH = false;
    this.animationSeconds = 0;
}

function entity(x, y, sprite)
{
    this.type = "";
    this.position = new v2(x, y);
    this.sprite = sprite;
}

var entities = [];
function addEntity(entity)
{
    entities[entities.length] = entity;
}

var HalfPI = Math.PI/2;

var playerSpriteLeft = new animatedFrameSprite("data/player/FarmerWalkLeft", 4, 6);
var playerSpriteRight = new animatedFrameSprite("data/player/FarmerWalkRight", 4, 6);
var playerSpriteUp = new animatedFrameSprite("data/player/FarmerWalkUp", 4, 6);
var playerSpriteDown = new animatedFrameSprite("data/player/FarmerWalkDown", 4, 6);

var cameraOffset = new v2(0, 0);
var playerSpawn = new v2(0, 0);
var playerAction = null;

var mapData = new Object();
loadMap(map1);
var player = new entity(playerSpawn.x, playerSpawn.y, playerSpriteDown.frames[0]);
addEntity(player);

var daylightRate = 0;
var hourOfDay = 0;

// var gameSong = new Audio("data/audio/rockets_land.wav");
// gameSong.loop = true;

//
//====== GAME LOOP ======
//

var debug = false;
var lastUpdateTime;
function main()
{
	var now = Date.now();
    var secondsSinceUpdate = (now - lastUpdateTime) / 1000;
	update(secondsSinceUpdate);
	draw();
    
    if(debug)
    {
        canvasContext.font = "12px Arial";
        canvasContext.fillStyle = "#000000";
        var y = 10;
        canvasContext.fillText(secondsSinceUpdate,10,y);
        y += 14;
        //canvasContext.fillText("V:" + v2Length(player.motion.velocity), 10, y);
    }
        
	lastUpdateTime = now;
	requestAnimationFrame(main);
};

function reset()
{
    lastUpdateTime = Date.now();
}

reset();
main();

//
//====== MAP LOADING ======
//

// Note(ian): This code specifically loads maps made in the tiled editor.
function loadMap(mapJson)
{
    mapData.width = mapJson.width;
    mapData.height = mapJson.height;
    mapData.tileWidth = mapJson.tilewidth;
    mapData.tileHeight = mapJson.tileheight;
	mapData.tileSets = [];
    mapData.layers = [];
	mapData.collisionTiles = [mapJson.width * mapJson.height];
    
    for(var i = 0; i < mapJson.tilesets.length; i++)
    {
        var tileSetJson = mapJson.tilesets[i];
		var newTileSet = {};
		newTileSet.firstId = tileSetJson.firstgid;
		newTileSet.tileCount = tileSetJson.tilecount;
		newTileSet.widthInTiles = tileSetJson.columns;
		newTileSet.image = new Image();
		newTileSet.image.src = "data/" + tileSetJson.image;
		mapData.tileSets[mapData.tileSets.length] = newTileSet;
    }
	
    for(var i = 0; i < mapJson.layers.length; i++)
    {
        var layer = mapJson.layers[i];
        if(layer.type == "tilelayer")
        {
            if(layer.name == "collision")
            {
                for(var tileX = 0;
                    tileX < mapData.width;
                    tileX++)
                {
                    for(var tileY = 0;
                        tileY < mapData.height;
                        tileY++)
                    {
						var spriteId = layer.data[tileX + (tileY * mapData.width)]
						mapData.collisionTiles[tileX + (tileY * mapData.width)] = spriteId;
                    }
                }
            }
            else
            {
				mapData.layers[mapData.layers.length] = layer;
                // layerZ++;
            }
        }
        else if(layer.type == "objectgroup")
        {
			if(layer.name == "Data")
			{
				for(var j = 0; j < layer.objects.length; j++)
                {
					var object = layer.objects[j];
					var position = new v2(object.x, object.y);
					// var tilePosition = new v2(
						// Math.floor(position.x),
						// Math.floor(position.y)
						// );
					if(object.name == "playerSpawn")
					{
						position.x = Math.floor(position.x / mapData.tileWidth) * mapData.tileWidth;
						position.y = Math.floor(position.y / mapData.tileHeight) * mapData.tileHeight;
                        playerSpawn = position;
					}
                }
			}
        }
    }
}

//
//====== MATH ======
//

function v2(x, y)
{
    if(isNaN(x))
    {
        x = 0;
    }
    if(isNaN(y))
    {
        y = 0;
    }
    this.x = x;
    this.y = y;
}

function v2Multiply(one, scalar)
{
    var result = new v2();
    result.x = one.x * scalar;
    result.y = one.y * scalar;
    return result;
}

function v2MultiplyAssign(v2, scalar)
{
    v2.x *= scalar;
    v2.y *= scalar;
}

function v2Divide(one, scalar)
{
    var result = new v2();
    result.x = one.x / scalar;
    result.y = one.y / scalar;
    return result;
}

function v2DivideAssign(one, scalar)
{
    one.x = one.x / scalar;
    one.y = one.y / scalar;
}

function v2Add(one, two)
{
    var result = new v2();
    result.x = one.x + two.x;
    result.y = one.y + two.y;
    return result;
}

function v2AddAssign(one, two)
{
    one.x += two.x;
    one.y += two.y;
}

function v2Subtract(one, two)
{
    var result = new v2();
    result.x = one.x - two.x;
    result.y = one.y - two.y;
    return result;
}

function v2SubtractAssign(one, two)
{
    one.x -= two.x;
    one.y -= two.y;
}

function v2Length(a)
{
    var result = Math.pow(a.x, 2) + Math.pow(a.y, 2);
    result = Math.sqrt(result);
    return result;
}

function v2Inner(a, b)
{
    return Result = a.x*b.x + a.y*b.y;
}

function v2NormalizeAssign(a)
{
    if(a.x != 0 || a.y != 0)
    {
        v2DivideAssign(a, v2Length(a));
    }
}

function v2Normalize(a)
{
    var result = v2Copy(a);
    if(a.x != 0 || a.y != 0)
    {
        result = v2Divide(a, v2Length(a));
    }
    return result;
}

function v2Copy(v)
{
    return new v2(v.x, v.y);
}

function angleToV2(a)
{
    return new v2(-Math.cos(a), -Math.sin(a));
}

function rectangle(x, y, width, height)
{
    this.min = new v2(x, y);
	this.max = new v2(x + width, y + height);
}

function rectanglesAllignedOverlap(a, b)
{
	var result = !(
		a.min.x >= b.max.x ||
		b.min.x >= a.max.x ||
		a.min.y >= b.max.y ||
		b.min.y >= a.max.y
		);
	return result;
}

function lerp(v0, v1, t)
{
  return (1-t)*v0 + t*v1;
}

//
//====== COLOUR ======
//

//http://stackoverflow.com/questions/5560248/programmatically-lighten-or-darken-a-hex-color-or-rgb-and-blend-colors
function shadeBlend(p,c0,c1)
{
    var n=p<0?p*-1:p,u=Math.round,w=parseInt;
    if(c0.length>7)
    {
        var f=c0.split(","),t=(c1?c1:p<0?"rgb(0,0,0)":"rgb(255,255,255)").split(","),R=w(f[0].slice(4)),G=w(f[1]),B=w(f[2]);
        return "rgb("+(u((w(t[0].slice(4))-R)*n)+R)+","+(u((w(t[1])-G)*n)+G)+","+(u((w(t[2])-B)*n)+B)+")"
    }
    else
    {
        var f=w(c0.slice(1),16),t=w((c1?c1:p<0?"#000000":"#FFFFFF").slice(1),16),R1=f>>16,G1=f>>8&0x00FF,B1=f&0x0000FF;
        return "#"+(0x1000000+(u(((t>>16)-R1)*n)+R1)*0x10000+(u(((t>>8&0x00FF)-G1)*n)+G1)*0x100+(u(((t&0x0000FF)-B1)*n)+B1)).toString(16).slice(1)
    }
}

/*
var FPS = 30;
setInterval(function() {
  update();
  draw();
}, 1000/FPS);*/

/*
window.onload = function() {
    var sources = {
        resource1: "img/sprite1.png",
        resource2: "img/sprite2.png",
        resource3: "img/sprite3.png"
    };
    loadImages(sources, initGame);  // calls initGame after *all* images have finished loading
};

function loadImages(sources, callback) {
    var images = {};
    var loadedImages = 0;
    var numImages = 0;
    for (var src in sources) {
        numImages++;
    }
    for (var src in sources) {
        images[src] = new Image();
        images[src].onload = function(){
            if (++loadedImages >= numImages) {
                callback(images);
            }
        };
        images[src].src = sources[src];
    }
} 

function initGame(images) {
    // some code here...
}*/

//convert s_player_dead_0.png s_player_dead_1.png +append s_player_dead.png
